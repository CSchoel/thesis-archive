<!DOCTYPE html>
<html>
<head>
	<title>Nonpacemaker action potential of myocytes</title>
	<meta charset="UTF-8"/>
	<script src="../lib/jquery-2.2.0.js"></script>
	<script src="../lib/snap.svg.js"></script>
	<script src="../js/channel_anim.js"></script>
	<script type="text/javascript">
		var t0 = 0;
		var tend = 300;
		var animDur = 10000;
		var tglob = 0;
		var startPaths = {};
		var endPaths = {};
		var animPaths = {};
		var pOffs = {};
		var sglob;
		var anim = null;
		var slider;
		
		setStartStates = function(im) {
			findAndStore(im, startPaths, "t", "#time0");
			findAndStore(im, endPaths, "t", "#time300");
			// Open lid of fast Na+ channel
			var lid = im.select("#poreLid");
			var hinge = lid.node.pathSegList.getItem(0);
			lid.attr({transform: "r150 "+hinge.x+" "+hinge.y});
			// find start paths of fna pore
			findAndStore(im, startPaths, "fnal", "#poreLeft");
			findAndStore(im, endPaths, "fnal", "#poreLeftOpen");
			findAndStore(im, startPaths, "fnar", "#poreRight");
			findAndStore(im, endPaths, "fnar", "#poreRightOpen");
			// find start paths for fna Na+ ions
			findAndStoreP(im, "fnaIp_", 2, 2);

			//cal
			findAndStore(im, startPaths, "cal_l", "#cal_l");
			findAndStore(im, endPaths, "cal_l", "#cal_lo");
			findAndStore(im, startPaths, "cal_r", "#cal_r");
			findAndStore(im, endPaths, "cal_r", "#cal_ro");
			findAndStoreP(im, "calIp_", 20, 20);

			//ir
			animPaths["spermine"] = deepcopy(im.select("#spermine_path"));
			findAndStoreP(im, "irIp_", 20, 20);

			//to
			findAndStore(im, startPaths, "to_l", "#to_l");
			findAndStore(im, endPaths,   "to_l", "#to_lo");
			findAndStore(im, startPaths, "to_r", "#to_r");
			findAndStore(im, endPaths,   "to_r", "#to_ro");
			findAndStore(im, startPaths, "to_c", "#to_c");
			findAndStore(im, endPaths,   "to_c", "#to_ci");
			animPaths["to_b"] = deepcopy(im.select("#to_bp"));
			findAndStoreP(im, "toIp_", 2, 2);

		}

		findAndStore = function(image, obj, key, xml_id) {
			obj[key] = deepcopy(image.select(xml_id)).node.pathSegList;
		}

		findAndStoreP = function(image, prefix, noff, roff) {
			var i = 0;
			var p;
			while(p = image.select("#"+prefix + i)) {
				var k = prefix+i;
				animPaths[k] = deepcopy(p);
				if (noff > 0) {
					pOffs[k] = periodOffsets(noff, roff);	
				}
				i++;
			}	
		}
		
		// fast natrium channels
		fna = function(im, t) {
			// sets the opening percentage of the fast Na lid
			var lid = im.select("#poreLid");
			var hinge = lid.node.pathSegList.getItem(0);
			var act = [0, 5, 245, 250];
			var inact = [0, 17, 245, 263];
			var maxOpenIn = 150;
			var pact = rectRamp(t, act);
			var pinact = rectRamp(t, inact);
			var deg = (1 - pinact) * maxOpenIn;
			lid.attr({transform: "r"+deg+" "+hinge.x+" "+hinge.y});

			// sets the open property of the channel
			morph(pact,im.select("#poreLeft").node.pathSegList, startPaths["fnal"], endPaths["fnal"]);
			morph(pact,im.select("#poreRight").node.pathSegList, startPaths["fnar"], endPaths["fnar"]);
			
			// moves ions
			var ionPer = periods(5,15,2);
			moveIons(im, t, ionPer, "fnaIp_", "#fnaI_");
		}

		// l-type calcium channels
		cal = function(im, t) {
			var lid = im.select("#cal_lid");
			var hinge = [lid.attr("x"), lid.attr("y")];
			var act = [7, 17, 200, 210]
			var inact = [17, 167, 200, 350]
			var maxOpenIn = 150;
			var pact = rectRamp(t, act);
			var pinact = rectRamp(t, inact);
			var deg = (1 - pinact) * maxOpenIn;
			lid.attr({transform: "r"+deg+" "+hinge[0]+" "+hinge[1]});

			morph(pact, im.select("#cal_l").node.pathSegList, startPaths["cal_l"], endPaths["cal_l"]);
			morph(pact, im.select("#cal_r").node.pathSegList, startPaths["cal_r"], endPaths["cal_r"]);

			var ionPer = periods(17, 150, 5);
			moveIons(im, t, ionPer, "calIp_", "#calI_");
		}

		// inward rectifier
		ir = function(im, t) {
			var sp = im.select("#spermine");
			var spp = animPaths["spermine"];
			var act = [200, 220, 350, 351];
			var pact = rectRamp(t, act);

			var l = spp.getTotalLength() * pact;
			var p = spp.getPointAtLength(l);
			sp.node.pathSegList.getItem(0).x = p.x;
			sp.node.pathSegList.getItem(0).y = p.y;
			sp.attr("transform", "r "+(p.alpha+90));

			var ionPer = periods(220, 350, 5);
			moveIons(im, t, ionPer, "irIp_", "#irI_");
		}

		// transient outward
		to = function(im, t) {
			var ball = im.select("#to_b");
			var ball_path = animPaths["to_b"];
			act = [8, 12, 182, 186];
			inact = [8, 32, 182, 205];
			pact = rectRamp(t, act);
			pinact = rectRamp(t, inact);

			// move ball
			var l = ball_path.getTotalLength() * pinact;
			var p = ball_path.getPointAtLength(l);
			ball.attr({cx: p.x, cy: p.y});

			// morph chain
			morph(pinact, im.select("#to_c").node.pathSegList, startPaths["to_c"], endPaths["to_c"]);
			// morph activation gates
			morph(pact, im.select("#to_l").node.pathSegList, startPaths["to_l"], endPaths["to_l"]);
			morph(pact, im.select("#to_r").node.pathSegList, startPaths["to_r"], endPaths["to_r"]);

			var ionPer = periods(10, 30, 2);
			moveIons(im, t, ionPer, "toIp_", "#toI_");
		}

		moveIons = function(image, t, periods, path_prefix, xml_prefix) {
			var i = 0;
			var ion;
			while (ion = image.select(xml_prefix + i)) {
				var k = path_prefix + i;
				moveAlongPath(t, addOff(periods, pOffs[k]), ion, animPaths[k]);
				i++;
			}
		}

		updateAnim = function(im, t) {
			// update time slider
			morph(1.0 * t / tend, im.select("#time0").node.pathSegList, startPaths["t"], endPaths["t"]);
			fna(im, t);
			cal(im, t);
			ir(im, t);
			to(im, t);
			slider.value = t;
		}

		setTime = function(t) {
			if (anim) {
				anim.stop();
				anim = null;	
			}
			updateAnim(sglob, t);
		}

		playPause = function() {
			if(anim) {
				anim.stop();
				anim = null;
			} else {
				anim = Snap.animate(slider.value, tend, function(t) { updateAnim(sglob, t); }, animDur);
			}
		}
		
		window.onload = function() {
			var s = Snap("#svg");
			Snap.load("ion_channels_animation_nonpacemaker_base.svg", function(f) {
				setStartStates(f);
				s.append(f.select("g"));
			});
			sglob = s;
			slider = document.getElementById('slider');
			slider.min = t0;
			slider.max = tend;
		}
	</script>
</head>
<body>
	<svg id="svg" style="width:1000px;height:500px;">
	</svg>
	<div>
		<div>
			<input id="slider" type="range" name="time" min="0" max="300" value="0" oninput="setTime(this.value); $('#sliderT').text(this.value+' ms')"/> <span id="sliderT">0 ms</span>
		</div>
		<input type="button" name="playPause" onclick="playPause()" value="Play/Pause"/>
	</div>
</body>
</html>